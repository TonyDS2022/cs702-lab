---
title: "Lab Week 3. Bayesian Inference"
---

## Introduction

This week's lab explores Bayesian inference—a framework for updating beliefs based on new evidence. You'll learn to formulate probabilistic models, represent them graphically using plate notation, and implement them with NumPyro, a probabilistic programming language built on JAX.

Read the scenario below and work through Q1–Q4. Each question builds on the previous one, moving from model specification to implementation and inference.

> An e-commerce company has collected user log data showing how users interact with their website to complete purchase transactions. Each transaction involves several steps, such as product selection, shipping information entry, and payment processing. The company wants to use this transaction log data to model user behavior using Bayesian inference.

## Q1. Probabilistic Modeling

Assume the total time users spend completing the checkout process follows an exponential distribution with rate parameter $\lambda$. Given that the average purchase time is approximately 10 seconds, build a Bayesian model by setting a prior over $\lambda$ rather than directly fixing $\lambda = 0.1$. Propose a reasonable prior distribution for $\lambda$, specify its parameters, and briefly explain your choice. Then, express the complete probabilistic model mathematically.

::: {.callout-tip title="Answer" icon=false}

We desire a distribution to encode our prior belief about the rate parameter $\lambda$ should approximately be $0.1$. Importantly, the distribution should satisfy the property $\lambda > 0$ and be a conjugate prior to the exponential distribution.

We can select $\lambda \sim \Gamma(1, 10)$ as a weakly informative prior with mean $0.1$ and standard deviation $0.1$.

The complete probabilistic model is given by:

$$
\begin{aligned}
\lambda_{0} &\sim \Gamma(1, 10), \\
\lambda | T_{1:n} &\sim \Gamma\left(1 + n, 10 + \sum_{i=1}^{n} T_i\right), \\
T_{i} | \lambda &\sim \text{Exp}(\lambda),\;i=1,\,\ldots,\,n.
\end{aligned}
$$

:::

## Q2. Plate Diagram

Draw the plate notation for your model. Recall that a plate diagram constitutes a graphical representation of a probabilistic model where nodes represent random variables, edges represent dependencies, and plates (rectangles) represent repeated sampling or independent replications of variables across multiple observations or groups.

::: {.callout-tip title="Answer" icon=false}

The plate diagram for the model in Q1 is shown below. The rate parameter $\lambda$ is sampled once from the Gamma prior, while the checkout times $T_i$ are conditionally independent given $\lambda$ and sampled repeatedly for each of the $n$ observations. The shaded node indicates that $T_i$ is observed.

```{mermaid}
%%| fig-align: center
%%| fig-width: 4
%%{init: {'theme': 'dark', 'themeVariables': { 'primaryColor': '#2a2a2a', 'primaryTextColor': '#fff', 'lineColor': '#888' }}}%%
flowchart TD
    subgraph prior[" "]
        lambda(("λ"))
    end

    subgraph plate["&emsp;&emsp;&emsp; N observations &emsp;&emsp;&emsp;"]
        T(("T<sub>i</sub>"))
    end

    lambda --> T

    style lambda fill:#1a1a1a,stroke:#888,stroke-width:2px,color:#67A902
    style T fill:#444,stroke:#888,stroke-width:2px,color:#fff
    style plate fill:none,stroke:#6a8759,stroke-width:1px,stroke-dasharray:5
    style prior fill:none,stroke:none
```

**Legend:**

- $\lambda \sim \Gamma(1, 10)$ — latent rate parameter (unshaded)
- $T_i | \lambda \sim \text{Exp}(\lambda)$ — observed checkout times (shaded)
- The plate indicates $i = 1, \ldots, n$ independent observations

:::

## Q3. Probabilistic Programming Language (PPL)

Consider the following code that defines a hierarchical probabilistic model using the NumPyro library:

```python
def hierarchical_model(group_ids=None, checkout_times=None):
    """
    Args:
        group_ids: Group IDs for each observation (0=Group A, 1=Group B)
        checkout_times: Observed checkout times
    """
    alpha_groups = jnp.array([12.0, 8.0])
    beta_groups = jnp.array([100.0, 100.0])

    lambda_groups = numpyro.sample(
        "lambda_groups",
        dist.Gamma(alpha_groups, beta_groups).expand([2])
    )

    with numpyro.plate("data", len(checkout_times) if checkout_times is not None else 1):
        numpyro.sample(
            "checkout_times",
            dist.Exponential(lambda_groups[group_ids]),
            obs=checkout_times
        )
```

Describe the model's structure and explain how it differs from the models in Q1 and Q2. Interpret the prior distributions for each group and what they suggest about expected checkout times. Then, explain what this model means for the e-commerce company and what insights might it provide.

::: {.callout-tip title="Answer" icon=false}

The code describes a hierarchical Bayesian model with two user groups (A and B), parameterized by rate parameters $\lambda_A$ and $\lambda_B$. Formally:

$$
\begin{aligned}
\lambda_A &\sim \Gamma(12, 100), \\
\lambda_B &\sim \Gamma(8, 100), \\
T_i | \lambda_{g_i} &\sim \text{Exp}(\lambda_{g_i}), \quad i = 1, \ldots, n,
\end{aligned}
$$

where $g_i \in \{A, B\}$ is the group assignment for observation $i$.

The model described in Q1 and Q2 is parameterized by a single rate parameter $\lambda$ across all observations, implyling that user behavior is homogeneous across all groups. The model in this question allows heterogeneous user behavior based on user segment membership.

:::

## Q4. Using PPL

Write a Python function using NumPyro to implement the model from Q1. Your function should:

- Define a prior distribution for the rate parameter $\lambda$ based on your answer to Q1
- Use an Exponential likelihood for the observed checkout times
- Accept observed checkout times as input

Then, use your function to perform inference on the following synthetic dataset of checkout times (in seconds):

```python
checkout_times = jnp.array([8.2, 12.5, 9.1, 15.3, 7.8, 11.2, 10.5, 13.7, 9.9, 14.1])
```

Use MCMC with the NUTS sampler to obtain posterior samples. Report:

1. The posterior mean and 95% highest density interval for $\lambda$
2. A visualization of the prior and posterior distributions for $\lambda$
3. Based on your posterior inference, what is the updated expected checkout time?
